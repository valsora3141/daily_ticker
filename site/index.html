<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#080808">
    <title>ì¼ì¼í‹°ì»¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#080808;--card:#111;--card-border:#1c1c1c;--text:#d4d4d4;--dim:#666;--muted:#444;--green:#22c55e;--blue:#3b82f6;--yellow:#ca8a04;--red:#ef4444;--font:'Noto Sans KR',sans-serif;--mono:'JetBrains Mono',monospace}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh}
        .header{position:sticky;top:0;z-index:100;background:rgba(8,8,8,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:12px 16px 8px;border-bottom:1px solid #1a1a1a}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .logo{font-size:1.1rem;font-weight:700;letter-spacing:-.5px}.logo span{color:var(--green)}
        .date-info{font-size:.68rem;color:var(--dim);font-family:var(--mono)}
        .stats{font-size:.7rem;color:var(--muted);margin-bottom:8px}
        .tabs{display:flex;border-radius:8px;overflow:hidden;background:#0e0e0e;border:1px solid #1a1a1a}
        .tab{flex:1;padding:8px 0;text-align:center;font-size:.72rem;font-weight:600;color:var(--muted);cursor:pointer;border:none;background:0 0;font-family:var(--font);transition:all .2s}
        .tab.active{background:#1a1a1a;color:var(--text)}
        .filter-bar{display:flex;gap:6px;padding:10px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .filter-bar::-webkit-scrollbar{display:none}
        .filter-chip{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:.68rem;font-weight:600;border:1px solid #222;background:#111;color:var(--dim);cursor:pointer;font-family:var(--font);transition:all .15s}
        .filter-chip.active{border-color:var(--green);color:var(--green);background:#0a1a0a}
        .content{padding:0 12px 80px}
        .banner{margin:8px 0 12px;padding:10px 12px;background:#100e00;border:1px solid #2a2400;border-radius:10px;font-size:.72rem;color:#b8960a;line-height:1.6}
        .banner b{color:#dab508}
        .stale-banner{margin:8px 12px;padding:8px 12px;background:#1a0a0a;border:1px solid #3a1a1a;border-radius:8px;font-size:.72rem;color:#e05555;line-height:1.5}
        .card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;margin-bottom:8px;overflow:hidden;animation:fadeUp .3s ease both}
        .card.favorited{border-left:3px solid var(--yellow)}
        .card-main{padding:12px 14px;cursor:pointer}
        .card-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .ticker-group{display:flex;align-items:center;gap:8px}
        .fav-btn{background:0 0;border:none;font-size:1rem;cursor:pointer;padding:0 4px;opacity:.3;transition:opacity .15s}
        .fav-btn.active{opacity:1}
        .ticker-code{font-family:var(--mono);font-size:.82rem;font-weight:600;color:#fff}
        .ticker-name{font-size:.75rem;color:#999}
        .grade-badge{font-family:var(--mono);font-size:.65rem;font-weight:700;padding:2px 8px;border-radius:4px;letter-spacing:.5px}
        .grade-A{background:#0a2a0a;color:var(--green)}.grade-B{background:#0a1a2a;color:var(--blue)}.grade-C{background:#1a1a0a;color:var(--yellow)}.grade-D{background:#1a1010;color:#666}.grade-ë¯¸ë‹¬{background:#1a1010;color:#555}
        .prob-row{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:6px}
        .prob-cell{text-align:center}
        .prob-label{font-size:.58rem;color:var(--muted);margin-bottom:2px;font-family:var(--mono)}
        .prob-bar{height:22px;background:#0a0a0a;border-radius:4px;position:relative;overflow:hidden}
        .prob-fill{height:100%;border-radius:4px;transition:width .4s ease-out}
        .prob-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:.68rem;font-weight:600;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.9)}
        .card-summary{font-size:.68rem;color:var(--dim);line-height:1.4}
        .card-expand{display:flex;justify-content:center;padding:2px 0 0}
        .expand-arrow{font-size:.6rem;color:var(--muted);transition:transform .2s}
        .card.open .expand-arrow{transform:rotate(180deg)}
        .card-detail{max-height:0;overflow:hidden;transition:max-height .3s ease}
        .card.open .card-detail{max-height:600px}
        .detail-inner{padding:0 14px 14px}
        .detail-section{padding:10px;border-radius:8px;margin-bottom:8px;font-size:.75rem;line-height:1.7}
        .detail-why{background:#0c0c0c;color:#bbb}
        .detail-why .hl{color:#fff;font-weight:600}.detail-why .up{color:var(--red)}.detail-why .gd{color:var(--green)}
        .detail-caution{background:#110f00;border-left:3px solid #6b5300;color:#b8960a}
        .detail-caution b{color:#dab508}
        .detail-features{display:grid;grid-template-columns:repeat(2,1fr);gap:4px 12px;font-size:.68rem;color:var(--dim);font-family:var(--mono);padding:8px 10px;background:#0c0c0c;border-radius:8px}
        .detail-features .lb{color:var(--muted)}
        .sort-bar{display:flex;justify-content:flex-end;padding:0 4px 6px}
        .sort-select{background:#111;border:1px solid #222;color:var(--dim);font-size:.68rem;padding:4px 8px;border-radius:6px;font-family:var(--font)}
        .search-box{margin:12px 0;display:flex;gap:8px}
        .search-input{flex:1;background:#0e0e0e;border:1px solid #222;color:var(--text);font-size:.82rem;padding:10px 12px;border-radius:8px;font-family:var(--mono);outline:none}
        .search-input:focus{border-color:var(--green)}
        .search-input::placeholder{color:var(--muted)}
        .search-result{margin:8px 0;padding:10px 12px;background:#0e0e0e;border:1px solid #1a1a1a;border-radius:8px;font-size:.75rem;color:var(--dim)}
        .search-result .not-found{color:var(--muted)}
        .history-card{background:var(--card);border:1px solid var(--card-border);border-radius:10px;padding:12px;margin-bottom:8px}
        .history-date{font-family:var(--mono);font-size:.72rem;color:var(--dim);margin-bottom:6px}
        .history-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a;font-size:.72rem}
        .history-item:last-child{border-bottom:none}
        .result-hit{color:var(--green);font-weight:600;font-family:var(--mono)}
        .result-miss{color:var(--red);font-weight:600;font-family:var(--mono)}
        .empty-msg{text-align:center;padding:40px 16px;color:var(--muted);font-size:.78rem;line-height:1.6}
        .footer{text-align:center;padding:16px;font-size:.62rem;color:var(--muted);line-height:1.5}
        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .card:nth-child(1){animation-delay:.03s}.card:nth-child(2){animation-delay:.06s}.card:nth-child(3){animation-delay:.09s}.card:nth-child(4){animation-delay:.12s}.card:nth-child(5){animation-delay:.15s}
        .card:nth-child(6){animation-delay:.18s}.card:nth-child(7){animation-delay:.21s}.card:nth-child(8){animation-delay:.24s}.card:nth-child(9){animation-delay:.27s}.card:nth-child(10){animation-delay:.3s}
    </style>
</head>
<body>
<div class="header">
    <div class="header-top">
        <div class="logo">ì¼ì¼<span>í‹°ì»¤</span></div>
        <div class="date-info" id="date-info">â€”</div>
    </div>
    <div class="stats" id="stats">ë¡œë”© ì¤‘...</div>
    <div class="tabs">
        <button class="tab active" data-tab="recs">ì¶”ì²œ</button>
        <button class="tab" data-tab="watchlist">ê´€ì‹¬</button>
        <button class="tab" data-tab="history">ê²€ì¦</button>
    </div>
</div>

<div class="content tab-content" id="tab-recs">
    <div class="banner">
        âš ï¸ <b>ì½ëŠ” ë²•</b>: í™•ë¥ ì€ "ë‚´ì¼ ì‹œê°€ì— ì‚¬ë©´, ì¥ì¤‘ í•´ë‹¹ ìˆ˜ìµì— ë„ë‹¬í•  ê°€ëŠ¥ì„±"ì…ë‹ˆë‹¤.
        <br>ì˜ˆ) +2.0%: 45% â†’ 10ë²ˆ ì¤‘ ì•½ 4~5ë²ˆì€ ì¥ì¤‘ +2% ì´ìƒ ì˜¤ë¥¸ ì ì´ ìˆë‹¤ëŠ” ëœ».
        <br><b>- í™•ë¥ ì´ ë†’ë‹¤ â‰  ë°˜ë“œì‹œ ì˜¤ë¥¸ë‹¤.</b> ì°¸ê³ ë§Œ í•  ê²ƒ.
        <br>- ì›¬ë§Œí•˜ë©´ ì•„ ë” ì˜¤ë¥¼ ê²ƒ ê°™ì€ë° í•  ë•Œ ë§Œì¡±í•˜ê³  íŒŒëŠ”ê²Œ ì¥ê¸°ì ìœ¼ë¡œ ì´ë“ì…ë‹ˆë‹¤.
        <br><b>- ì¥ ì‹œì‘ê°€ì— ì‚¬ì„œ ì˜¤ëŠ˜ ì•ˆì— íŒ” ë•Œ</b> ì˜¤ë¥¼ í™•ë¥ ì…ë‹ˆë‹¤.
        <br><b>ë‹¹ì¼ì²­ì‚°(ìŠ¤ìº˜í•‘)ì´ ì•„ë‹Œ ê²½ìš° ì‚¬ì´íŠ¸ì˜ ë°ì´í„°ê°€ ì „í˜€ ë„ì›€ë˜ì§€ ì•Šì„ í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.</b>
        <br>- ìµœìƒìœ„ 10ê°œ í‹°ì»¤ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ê´€ì‹¬ í‹°ì»¤â†’ê²€ìƒ‰ í†µí•´ì„œ ë³¼ ê²ƒ.
        <br>- ë“±ê¸‰ <b>ë¯¸ë‹¬</b> = ê¸°ë³¸ ì¡°ê±´(MAì •ë°°ì—´, ì™¸êµ­ì¸ ë§¤ìˆ˜ ë“±)ì„ ì¶©ì¡±í•˜ì§€ ëª»í•œ ì¢…ëª©. í™•ë¥  ì‚°ì¶œ ë¶ˆê°€.
    </div>
    <div class="filter-bar" id="filter-bar">
        <button class="filter-chip active" data-filter="all">ì „ì²´</button>
        <button class="filter-chip" data-filter="A">Aë“±ê¸‰</button>
        <button class="filter-chip" data-filter="B">Bë“±ê¸‰</button>
        <button class="filter-chip" data-filter="C">Cë“±ê¸‰</button>
        <button class="filter-chip" data-filter="fav">â­ ê´€ì‹¬ë§Œ</button>
    </div>
    <div class="sort-bar">
        <select class="sort-select" id="sort-select">
            <option value="prob_2_0">+2% í™•ë¥ ìˆœ</option>
            <option value="prob_3_0">+3% í™•ë¥ ìˆœ</option>
            <option value="prob_1_5">+1.5% í™•ë¥ ìˆœ</option>
            <option value="grade">ë“±ê¸‰ìˆœ</option>
            <option value="change_pct">ì „ì¼ ë“±ë½ìˆœ</option>
        </select>
    </div>
    <div id="rec-list"></div>
</div>

<div class="content tab-content" id="tab-watchlist" style="display:none">
    <div style="padding-top:12px">
        <div class="search-box">
            <input class="search-input" id="search-input" type="text" placeholder="ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª… ê²€ìƒ‰ (ì˜ˆ: 005930, ì‚¼ì„±ì „ì)" inputmode="search">
        </div>
        <div id="search-result"></div>
        <div style="font-size:.7rem;color:var(--muted);padding:4px 0 8px;border-bottom:1px solid #1a1a1a;margin-bottom:8px">â­ ê´€ì‹¬ ì¢…ëª©</div>
        <div id="watchlist-content"></div>
    </div>
</div>

<div class="content tab-content" id="tab-history" style="display:none">
    <div class="banner">ğŸ“Š ê³¼ê±° ì¶”ì²œ ì¢…ëª©ì´ ì‹¤ì œë¡œ ëª©í‘œì— ë„ë‹¬í–ˆëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
    <div id="history-content"><div class="empty-msg">ê²€ì¦ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.<br>ë§¤ì¼ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div></div>
</div>

<div class="footer">ê³¼ê±° 6ë…„ KOSPI ë°ì´í„° ê¸°ë°˜ í†µê³„ ëª¨ë¸ (17ê°œ ë³€ìˆ˜)<br>Brier 0.16~0.23 | íˆ¬ì íŒë‹¨ì€ ë³¸ì¸ ì±…ì„</div>

<script>
let allData=null,allRecs=[],allCandidates=[],searchIndex=[],favorites=JSON.parse(localStorage.getItem('ilil_favs')||'[]'),currentFilter='all',currentSort='prob_2_0';

function pc(p){return p>=50?'var(--green)':p>=40?'var(--blue)':p>=30?'var(--yellow)':'#333'}

function bW(t){
    const p=[];const c=t.change_pct;
    if(c>=10)p.push(`ì–´ì œ <span class="up hl">+${c}%</span> í¬ê²Œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`);
    else if(c>=5)p.push(`ì–´ì œ <span class="up hl">+${c}%</span> ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`);
    else if(c>=0)p.push(`ì–´ì œ <span class="hl">+${c}%</span> ì†Œí­ ì˜¬ëìŠµë‹ˆë‹¤.`);
    else p.push(`ì–´ì œ <span class="hl">${c}%</span> í•˜ë½í–ˆì§€ë§Œ ë‹¤ë¥¸ ì¡°ê±´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.`);
    const v=t.volume_ratio;
    if(v>=5)p.push(`ê±°ë˜ëŸ‰ì´ í‰ì†Œì˜ <span class="hl">${v.toFixed(1)}ë°°</span>ë¡œ ë§¤ìš° í¬ê²Œ ëª°ë ¸ìŠµë‹ˆë‹¤.`);
    else if(v>=2)p.push(`ê±°ë˜ëŸ‰ì´ í‰ì†Œì˜ <span class="hl">${v.toFixed(1)}ë°°</span>ë¡œ í™œë°œí•©ë‹ˆë‹¤.`);
    else if(v>=1.5)p.push(`ê±°ë˜ëŸ‰ì´ í‰ì†Œë³´ë‹¤ ë‹¤ì†Œ ë§ìŠµë‹ˆë‹¤ (${v.toFixed(1)}ë°°).`);
    const f=t.foreigner_trend,ins=t.institution_buying;
    if(f>=4&&ins)p.push(`<span class="gd">ì™¸êµ­ì¸ì´ ${f}ì¼ ì—°ì† ë§¤ìˆ˜</span> ì¤‘ì´ê³ , <span class="gd">ê¸°ê´€ë„ ë§¤ìˆ˜</span> ì¤‘ì…ë‹ˆë‹¤.`);
    else if(f>=3&&ins)p.push(`ì™¸êµ­ì¸ ${f}ì¼ì§¸ ë§¤ìˆ˜, ê¸°ê´€ë„ ë§¤ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.`);
    else if(f>=3)p.push(`ì™¸êµ­ì¸ì´ ${f}ì¼ì§¸ ë§¤ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.`);
    else if(ins)p.push(`ì™¸êµ­ì¸ ${f}ì¼ ë§¤ìˆ˜, ê¸°ê´€ë„ ë§¤ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.`);
    else p.push(`ì™¸êµ­ì¸ ${f}ì¼ ë§¤ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.`);
    if(t.return_5d>=20)p.push(`ìµœê·¼ 5ì¼ê°„ <span class="up">${t.return_5d.toFixed(1)}%</span> ê¸‰ë“± ìƒíƒœì…ë‹ˆë‹¤.`);
    else if(t.return_5d>=10)p.push(`ìµœê·¼ 5ì¼ê°„ ${t.return_5d.toFixed(1)}% ìƒìŠ¹ íë¦„ì…ë‹ˆë‹¤.`);
    return p.join(' ');
}

function bC(t){
    const p=[];const g=t.gap_from_ma20_pct;
    if(g>30)p.push(`20ì¼ í‰ê· ë³´ë‹¤ <b>${g.toFixed(0)}%</b> ìœ„ì— ìˆì–´ <b>ë§ì´ ì˜¬ë¼ì˜¨ ìƒíƒœ</b>ì…ë‹ˆë‹¤. ì¡°ì • ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.`);
    else if(g>15)p.push(`20ì¼ í‰ê· ë³´ë‹¤ ${g.toFixed(0)}% ìœ„ì— ìˆì–´ ë‹¤ì†Œ ë†’ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤.`);
    if(t.upper_shadow_ratio>.6)p.push(`ì–´ì œ ì¥ì¤‘ ì˜¬ëë‹¤ê°€ ë‹¤ì‹œ ë‚´ë ¤ì™”ìŠµë‹ˆë‹¤ (ìœ—ê¼¬ë¦¬). ë§¤ë„ ì••ë ¥ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    if(t.volume_ratio>4)p.push(`ê±°ë˜ëŸ‰ì´ <b>${t.volume_ratio.toFixed(1)}ë°°</b>ë¡œ, ê³¼ì—´ í›„ í•˜ë½ì´ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    if(t.risks&&t.risks.includes('ì¶”ê²©ë§¤ìˆ˜ ì£¼ì˜'))p.push(`ì „ê³ ì ì„ í¬ê²Œ ë„˜ì–´ì„  ìƒíƒœ. ê³ ì ì— ë¬¼ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    return p.join(' ');
}

function bS(t){
    const p=[];
    if(t.change_pct>=5)p.push(`ì „ì¼ +${t.change_pct}%`);
    if(t.volume_ratio>=2)p.push(`ê±°ë˜ëŸ‰ ${t.volume_ratio.toFixed(1)}x`);
    if(t.foreigner_trend>=3)p.push(`ì™¸êµ­ì¸ ${t.foreigner_trend}ì¼`);
    if(t.institution_buying)p.push('ê¸°ê´€ ë§¤ìˆ˜');
    return p.join(' Â· ');
}

function renderCard(t,showFav){
    const fv=favorites.includes(t.ticker);
    const isMidal=t.grade==='ë¯¸ë‹¬';
    let pb;
    if(isMidal){
        pb=`<div style="text-align:center;padding:6px 0;font-size:.72rem;color:#555;background:#0a0a0a;border-radius:4px">ê¸°ë³¸ ì¡°ê±´ ë¯¸ë‹¬ â€” í™•ë¥  ì‚°ì¶œ ë¶ˆê°€</div>`;
    } else {
        const ths=[{l:'+1.5%',v:t.prob_1_5},{l:'+2.0%',v:t.prob_2_0},{l:'+2.5%',v:t.prob_2_5},{l:'+3.0%',v:t.prob_3_0}];
        pb=`<div class="prob-row">`+ths.map(h=>`<div class="prob-cell"><div class="prob-label">${h.l}</div><div class="prob-bar"><div class="prob-fill" style="width:${Math.min(h.v,100)}%;background:${pc(h.v)}"></div><div class="prob-num">${h.v.toFixed(1)}%</div></div></div>`).join('')+`</div>`;
    }
    const rankTag=t.featured?`<span style="font-size:.6rem;color:var(--green);margin-left:6px">TOP ${t.rank}</span>`:(t.rank?`<span style="font-size:.6rem;color:var(--muted);margin-left:6px">#${t.rank}/${allCandidates.length}</span>`:'');
    let detailHtml;
    if(isMidal){
        const reasons=(t.risks||[]).map(r=>`Â· ${r}`).join('<br>');
        detailHtml=`<div class="detail-section detail-caution">
            <b>âš ï¸ ì¶”ì²œ ê¸°ë³¸ ì¡°ê±´ ë¯¸ë‹¬ ì¢…ëª©ì…ë‹ˆë‹¤.</b><br>
            ${reasons||'ìƒì„¸ ì‚¬ìœ  ì—†ìŒ'}
            <br><br><span style="font-size:.68rem">í™•ë¥ ì´ ë†’ì•„ ë³´ì—¬ë„ êµ¬ì¡°ì  ì¡°ê±´(ì´ë™í‰ê· ì„  ì •ë°°ì—´, ì™¸êµ­ì¸ ë§¤ìˆ˜ ì¶”ì„¸ ë“±)ì„ ì¶©ì¡±í•˜ì§€ ëª»í•´ ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ë§¤ìˆ˜ë¥¼ ê¶Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
        </div>`;
    } else {
        const ct=bC(t);
        detailHtml=`<div class="detail-section detail-why">${bW(t)}</div>${ct?`<div class="detail-section detail-caution">âš ï¸ ${ct}</div>`:''}
            <div class="detail-features">
                <span><span class="lb">ì „ì¼ë“±ë½</span> ${t.change_pct>=0?'+':''}${t.change_pct}%</span>
                <span><span class="lb">ê±°ë˜ëŸ‰</span> ${t.volume_ratio.toFixed(1)}x</span>
                <span><span class="lb">MA20ê°­</span> ${t.gap_from_ma20_pct>=0?'+':''}${t.gap_from_ma20_pct.toFixed(1)}%</span>
                <span><span class="lb">ì™¸êµ­ì¸</span> ${t.foreigner_trend}ì¼ ì—°ì†</span>
                <span><span class="lb">ê¸°ê´€</span> ${t.institution_buying?'ë§¤ìˆ˜':'â€”'}</span>
                <span><span class="lb">5ì¼ìˆ˜ìµ</span> ${t.return_5d>=0?'+':''}${t.return_5d.toFixed(1)}%</span>
                <span><span class="lb">ìœ—ê¼¬ë¦¬</span> ${(t.upper_shadow_ratio*100).toFixed(0)}%</span>
                <span><span class="lb">ì™¸ì¸ê°•ë„</span> ${(t.foreigner_intensity*100).toFixed(1)}%</span>
            </div>`;
    }
    const summaryText=isMidal?`<span style="color:var(--yellow)">âš ï¸ ì¡°ê±´ ë¯¸ë‹¬ â€” ì°¸ê³ ìš©</span>`:bS(t);
    return`<div class="card ${fv?'favorited':''}" data-ticker="${t.ticker}">
        <div class="card-main" onclick="tglCard(this)">
            <div class="card-row1"><div class="ticker-group">
                ${showFav?`<button class="fav-btn ${fv?'active':''}" onclick="tglFav(event,'${t.ticker}')">â­</button>`:''}
                <span class="ticker-code">${t.ticker}</span><span class="ticker-name">${t.name||''}</span>${rankTag}
            </div><span class="grade-badge grade-${t.grade}">${t.grade}</span></div>
            ${pb}
            <div class="card-summary">${summaryText}</div>
            <div class="card-expand"><span class="expand-arrow">â–¼</span></div>
        </div>
        <div class="card-detail"><div class="detail-inner">
            ${detailHtml}
        </div></div>
    </div>`;
}

function renderRecs(){
    let fl;
    if(currentFilter==='fav'){
        fl=allCandidates.filter(t=>favorites.includes(t.ticker));
    } else {
        fl=[...allRecs];
        if(currentFilter!=='all')fl=fl.filter(t=>t.grade===currentFilter);
    }
    if(currentSort==='grade'){const o={A:0,B:1,C:2,D:3};fl.sort((a,b)=>(o[a.grade]||9)-(o[b.grade]||9))}
    else if(currentSort==='change_pct')fl.sort((a,b)=>b.change_pct-a.change_pct);
    else fl.sort((a,b)=>(b[currentSort]||0)-(a[currentSort]||0));
    const el=document.getElementById('rec-list');
    if(!fl.length){el.innerHTML=`<div class="empty-msg">${currentFilter==='fav'?'ê´€ì‹¬ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. â­ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.':'í•´ë‹¹ ì¡°ê±´ì˜ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>`;return}
    el.innerHTML=fl.map(t=>renderCard(t,true)).join('');
}

function tglCard(el){el.closest('.card').classList.toggle('open')}

function tglFav(e,tk){
    e.stopPropagation();
    const i=favorites.indexOf(tk);
    if(i>=0)favorites.splice(i,1);else favorites.push(tk);
    localStorage.setItem('ilil_favs',JSON.stringify(favorites));
    renderRecs();renderWL();
}

// â”€â”€â”€ Search â”€â”€â”€
function searchTicker(query){
    const el=document.getElementById('search-result');
    if(!query||query.length<2){el.innerHTML='';return}
    query=query.trim().toUpperCase();

    const found=allCandidates.find(t=>
        t.ticker===query||t.ticker.includes(query)||
        (t.name&&t.name.toUpperCase().includes(query))
    );

    if(found){
        const label=found.grade==='ë¯¸ë‹¬'
            ?`<div style="font-size:.7rem;color:var(--yellow);margin-bottom:4px">âš ï¸ ì¡°ê±´ ë¯¸ë‹¬ ì¢…ëª©</div>`
            :`<div style="font-size:.7rem;color:var(--dim);margin-bottom:4px">âœ… ì¡°ê±´ ì¶©ì¡± ì¢…ëª©</div>`;
        el.innerHTML=label+renderCard(found,true);
    } else {
        el.innerHTML=`<div class="search-result"><span class="not-found">
            "${query}" â€” í•´ë‹¹ ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            <span style="font-size:.68rem">ì¢…ëª©ì½”ë“œ(6ìë¦¬) ë˜ëŠ” ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</span>
        </span></div>`;
    }
}

let searchTimer;
document.getElementById('search-input').addEventListener('input',e=>{
    clearTimeout(searchTimer);
    searchTimer=setTimeout(()=>searchTicker(e.target.value),200);
});

function renderWL(){
    const el=document.getElementById('watchlist-content');
    const fv=allCandidates.filter(t=>favorites.includes(t.ticker));
    const missingFavs=favorites.filter(tk=>!allCandidates.find(t=>t.ticker===tk));

    if(!fv.length&&!missingFavs.length){el.innerHTML='<div class="empty-msg">ê´€ì‹¬ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>â­ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ê±°ë‚˜, ìœ„ì—ì„œ ê²€ìƒ‰í•˜ì„¸ìš”.</div>';return}

    let html=fv.map(t=>renderCard(t,true)).join('');

    if(missingFavs.length){
        html+=`<div style="font-size:.7rem;color:var(--muted);padding:12px 0 6px;border-top:1px solid #1a1a1a;margin-top:8px">ì˜¤ëŠ˜ ì¡°ê±´ ë¯¸ë‹¬ ì¢…ëª©</div>`;
        missingFavs.forEach(tk=>{
            const si=searchIndex.find(t=>t.ticker===tk);
            if(si){
                const ths=[{l:'+1.5%',v:si.prob_1_5},{l:'+2.0%',v:si.prob_2_0},{l:'+2.5%',v:si.prob_2_5},{l:'+3.0%',v:si.prob_3_0}];
                const pb=ths.map(h=>`<div class="prob-cell"><div class="prob-label">${h.l}</div><div class="prob-bar"><div class="prob-fill" style="width:${Math.min(h.v,100)}%;background:${pc(h.v)}"></div><div class="prob-num">${h.v.toFixed(1)}%</div></div></div>`).join('');
                const reasons=(si.rejection_reasons||[]).map(r=>`Â· ${r}`).join('<br>');
                html+=`<div class="card favorited"><div class="card-main" style="cursor:default">
                    <div class="card-row1"><div class="ticker-group">
                        <button class="fav-btn active" onclick="tglFav(event,'${tk}')">â­</button>
                        <span class="ticker-code">${tk}</span>
                        <span class="ticker-name">${si.name||''}</span>
                    </div><span style="font-size:.68rem;color:var(--yellow)">ì¡°ê±´ ë¯¸ë‹¬</span></div>
                    <div class="prob-row">${pb}</div>
                    <div style="font-size:.68rem;color:#b8960a;padding:6px 8px;background:#110f00;border-radius:6px;line-height:1.5">${reasons}</div>
                </div></div>`;
            } else {
                html+=`<div class="card"><div class="card-main" style="cursor:default">
                    <div class="card-row1"><div class="ticker-group">
                        <button class="fav-btn active" onclick="tglFav(event,'${tk}')">â­</button>
                        <span class="ticker-code">${tk}</span>
                    </div><span style="font-size:.68rem;color:var(--muted)">ë°ì´í„° ì—†ìŒ</span></div>
                    <div style="font-size:.72rem;color:var(--muted);padding:4px 0">ì´ ì¢…ëª©ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                </div></div>`;
            }
        });
    }
    el.innerHTML=html;
}

async function loadHist(){
    try{const r=await fetch('./data/history.json');if(!r.ok)return;const h=await r.json();renderHist(h)}catch(e){}
}

function renderHist(h){
    const el=document.getElementById('history-content');
    if(!h||!h.days||!h.days.length){el.innerHTML='<div class="empty-msg">ê²€ì¦ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.<br>ë§¤ì¼ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';return}
    let tot=0,hit=0;
    h.days.forEach(d=>d.results.forEach(r=>{tot++;if(r.hit)hit++}));
    const acc=tot>0?(hit/tot*100).toFixed(1):0;
    let html=`<div class="history-card" style="text-align:center;margin:12px 0">
        <div style="font-size:.75rem;color:var(--dim);margin-bottom:4px">+2% ë„ë‹¬ ì ì¤‘ë¥  (ëˆ„ì )</div>
        <div style="font-size:1.8rem;font-weight:700;font-family:var(--mono);color:${acc>=40?'var(--green)':'var(--yellow)'}">${acc}%</div>
        <div style="font-size:.68rem;color:var(--muted)">${hit}/${tot}ê±´ ì ì¤‘</div>
    </div>`;
    h.days.slice(0,14).forEach(d=>{
        html+=`<div class="history-card"><div class="history-date">${d.date} (${d.hits}/${d.total} ì ì¤‘)</div>`;
        d.results.forEach(r=>{
            const cls=r.hit?'result-hit':'result-miss';
            const txt=r.hit?'âœ“ ë„ë‹¬':'âœ— ë¯¸ë‹¬';
            const act=r.actual_high_pct!==undefined?`(ìµœê³  +${r.actual_high_pct.toFixed(1)}%)`:'';
            html+=`<div class="history-item"><div><span style="font-weight:600">${r.ticker}</span> <span style="color:var(--muted)">${r.name||''}</span> <span style="color:var(--muted)">ì˜ˆì¸¡ ${r.predicted_prob.toFixed(0)}%</span></div><div class="${cls}">${txt} ${act}</div></div>`;
        });
        html+='</div>';
    });
    el.innerHTML=html;
}

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');
    const tg=t.dataset.tab;document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-'+tg).style.display='block';
    if(tg==='watchlist')renderWL();
}));

document.querySelectorAll('.filter-chip').forEach(c=>c.addEventListener('click',()=>{
    document.querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');
    currentFilter=c.dataset.filter;renderRecs();
}));

document.getElementById('sort-select').addEventListener('change',e=>{currentSort=e.target.value;renderRecs()});

async function init(){
    try{const r=await fetch('./data/latest.json');allData=await r.json();
    allRecs=allData.recommendations||[];
    allCandidates=allData.all_candidates||allRecs;
    searchIndex=allData.search_index||[];
    // Merge searchIndex into allCandidates with N/A defaults so all searches/filters work uniformly
    searchIndex.forEach(si=>{
        allCandidates.push({
            ticker:si.ticker,name:si.name||'',grade:'ë¯¸ë‹¬',
            prob_1_5:si.prob_1_5,prob_2_0:si.prob_2_0,prob_2_5:si.prob_2_5,prob_3_0:si.prob_3_0,
            change_pct:si.change_pct,volume_ratio:si.volume_ratio,gap_from_ma20_pct:si.gap_from_ma20_pct,
            foreigner_trend:si.foreigner_trend,institution_buying:si.institution_buying,
            return_5d:si.return_5d,upper_shadow_ratio:si.upper_shadow_ratio,foreigner_intensity:si.foreigner_intensity,
            risks:si.rejection_reasons||[],featured:false,rank:null
        });
    });
    document.getElementById('date-info').textContent=allData.date||'â€”';
    document.getElementById('stats').textContent=`${allData.screened_count||0}ì¢…ëª© â†’ ${allData.candidates_count||0}í†µê³¼ â†’ ${allRecs.length}ì¢…ëª©`;
    if(allData.is_stale){
        const s=document.createElement('div');s.className='stale-banner';
        s.innerHTML=`ğŸ“… íœ´ì¥ì¼ë¡œ ì¸í•´ <b>${allData.date}</b> ê¸°ì¤€ ë°ì´í„°ì…ë‹ˆë‹¤. ì¥ ê°œì¥ í›„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`;
        document.getElementById('tab-recs').insertBefore(s,document.getElementById('tab-recs').firstChild);
    }
    renderRecs();loadHist()}catch(e){document.getElementById('stats').textContent='ë°ì´í„° ë¡œë”© ì‹¤íŒ¨'}
}
init();
</script>
</body>
</html>