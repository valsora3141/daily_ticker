name: Daily Ticker Scan

on:
  schedule:
    - cron: '10 7 * * 1-5'  # 16:10 KST (07:10 UTC) Mon-Fri
  workflow_dispatch:          # Manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download database from release
        run: |
          gh release download db-latest \
            --pattern 'daily_cache.db.zip' \
            --dir data/ \
            --clobber 2>/dev/null || echo "No existing DB found"

          if [ -f data/daily_cache.db.zip ]; then
            cd data && unzip -o daily_cache.db.zip && rm daily_cache.db.zip && cd ..
            echo "DB downloaded: $(ls -lh data/daily_cache.db)"
          else
            echo "WARNING: No DB found."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore site data from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || echo "No gh-pages branch"
          mkdir -p site/data/archive

          # Restore history
          git show gh-pages:data/history.json > site/data/history.json 2>/dev/null || echo '{"days":[]}' > site/data/history.json

          # Restore previous latest.json (needed for archiving)
          git show gh-pages:data/latest.json > site/data/latest.json 2>/dev/null || echo "No previous latest.json"

          # Restore archived predictions
          for f in $(git ls-tree --name-only gh-pages:data/archive/ 2>/dev/null); do
            git show "gh-pages:data/archive/$f" > "site/data/archive/$f" 2>/dev/null || true
          done

          echo "Restored archive files: $(ls site/data/archive/ 2>/dev/null | wc -l)"

      - name: Update data and generate recommendations
        run: |
          python scripts/generate.py --update --retrain

      - name: Track history (verify previous predictions)
        run: |
          python scripts/track_history.py || echo "History tracking skipped"

      - name: Upload updated database to release
        run: |
          cd data && zip -r daily_cache.db.zip daily_cache.db && cd ..

          gh release delete db-latest --yes 2>/dev/null || true
          gh release create db-latest \
            data/daily_cache.db.zip \
            --title "Database (latest)" \
            --notes "Auto-updated $(date -u +%Y-%m-%d)" \
            --latest=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
